description: >
  Upload iOS App Directory on Autify For Mobile.

parameters:
  autify_project_id:
    type: string
    description: Autify project id
  autify_upload_token:
    type: string
    description: Autify Personal Access Token
  autify_app_dir_path:
    type: string
    description: App Direcotry Path
  mobile_cli_branch_name:
    type: string
    default: main
    description: Autify mobile cli branch name

steps:
  - run:
      name: Download Mobile CLI file
      command: |
        export AUTIFY_GITHUB_ORG="autifyhq"

        AUTIFY_MOBILE_SCRIPT_BRANCH="<<parameters.mobile_cli_branch_name>>"
        if [ -z "$AUTIFY_MOBILE_SCRIPT_BRANCH" ]; then
          AUTIFY_MOBILE_SCRIPT_BRANCH="main"
        fi
        if [[ "$AUTIFY_MOBILE_SCRIPT_BRANCH" =~ ":" ]]; then
          ORG=( "${AUTIFY_MOBILE_SCRIPT_BRANCH//:/ }" )
          AUTIFY_GITHUB_ORG=${ORG[0]}
          AUTIFY_MOBILE_SCRIPT_BRANCH=${ORG[1]}
        fi

        readonly AUTIFY_MOBILE_SCRIPT_NAME="autify_mobile_cli.sh"
        export AUTIFY_MOBILE_SCRIPT="https://raw.githubusercontent.com/${AUTIFY_GITHUB_ORG}/autify-for-mobile-cli/${AUTIFY_MOBILE_SCRIPT_BRANCH}/autify_mobile_cli.sh"
        readonly WORKIND_DIR="./"

        echo "* mobile_script_branch_name: ${AUTIFY_MOBILE_SCRIPT_BRANCH}"

        # download script
        curl -L -o "$WORKIND_DIR/$AUTIFY_MOBILE_SCRIPT_NAME" "$AUTIFY_MOBILE_SCRIPT"
        chmod 755 "$WORKIND_DIR/$AUTIFY_MOBILE_SCRIPT_NAME"
  - run:
      name: Upload app directory
      command: |
        export AUTIFY_PROJECT_ID="<<parameters.autify_project_id>>"
        export AUTIFY_APP_DIR_PATH="<<parameters.autify_app_dir_path>>"
        export AUTIFY_UPLOAD_TOKEN="<<parameters.autify_upload_token>>"
        exec ./autify_mobile_cli.sh
